# uncomment next line to start profiling
# zmodload zsh/zprof
# uset ttyctl -f to freeze terminal preventing any new changes to the tty
# ttyctl -u unfreezes the terminal
export NVM_LAZY=1
export GOPATH=$HOME/go


export PATH="/opt/homebrew/opt/gnu-sed/libexec/gnubin:$GOPATH/bin:$HOME/.luarocks/bin:/opt/homebrew/bin:$HOME/.npm-packages/bin:$HOME/local/bin:$HOME/local/node/bin:$HOME/local/yarn/bin:$HOME/bin:/usr/local/bin:/usr/local/share/dotnet:$HOME/.cargo/bin:$PATH:$HOME/nvim-macos/bin:$HOME/.fzf/bin"
typeset -U path
typeset -U PATH
# 10ms for key sequences
export KEYTIMEOUT=1

export PASSWORD_STORE_CHARACTER_SET='[:alnum:]!&%^@{}[]()'

export LANGUAGE=en_US.UTF-8
export LANG=en_US.UTF-8
export LC_TYPE=en_US.UTF-8
export LC_ALL=en_US.UTF-8
export CGO_ENABLED=0

unset LSCOLOR
export CLICOLOR=1
export LS_COLORS="*~=0;38;2;88;91;112:bd=0;38;2;116;199;236;48;2;49;50;68:ca=0:cd=0;38;2;245;194;231;48;2;49;50;68:di=0;38;2;137;180;250:do=0;38;2;17;17;27;48;2;245;194;231:ex=1;38;2;243;139;168:fi=0:ln=0;38;2;245;194;231:mh=0:mi=0;38;2;17;17;27;48;2;243;139;168:no=0:or=0;38;2;17;17;27;48;2;243;139;168:ow=0:pi=0;38;2;17;17;27;48;2;137;180;250:rs=0:sg=0:so=0;38;2;17;17;27;48;2;245;194;231:st=0:su=0:tw=0:*.a=1;38;2;243;139;168:*.c=0;38;2;166;227;161:*.d=0;38;2;166;227;161:*.h=0;38;2;166;227;161:*.m=0;38;2;166;227;161:*.o=0;38;2;88;91;112:*.p=0;38;2;166;227;161:*.r=0;38;2;166;227;161:*.t=0;38;2;166;227;161:*.z=4;38;2;116;199;236:*.7z=4;38;2;116;199;236:*.as=0;38;2;166;227;161:*.bc=0;38;2;88;91;112:*.bz=4;38;2;116;199;236:*.cc=0;38;2;166;227;161:*.cp=0;38;2;166;227;161:*.cr=0;38;2;166;227;161:*.cs=0;38;2;166;227;161:*.di=0;38;2;166;227;161:*.el=0;38;2;166;227;161:*.ex=0;38;2;166;227;161:*.fs=0;38;2;166;227;161:*.go=0;38;2;166;227;161:*.gv=0;38;2;166;227;161:*.gz=4;38;2;116;199;236:*.hh=0;38;2;166;227;161:*.hi=0;38;2;88;91;112:*.hs=0;38;2;166;227;161:*.jl=0;38;2;166;227;161:*.js=0;38;2;166;227;161:*.ko=1;38;2;243;139;168:*.kt=0;38;2;166;227;161:*.la=0;38;2;88;91;112:*.ll=0;38;2;166;227;161:*.lo=0;38;2;88;91;112:*.md=0;38;2;249;226;175:*.ml=0;38;2;166;227;161:*.mn=0;38;2;166;227;161:*.nb=0;38;2;166;227;161:*.pl=0;38;2;166;227;161:*.pm=0;38;2;166;227;161:*.pp=0;38;2;166;227;161:*.ps=0;38;2;243;139;168:*.py=0;38;2;166;227;161:*.rb=0;38;2;166;227;161:*.rm=0;38;2;242;205;205:*.rs=0;38;2;166;227;161:*.sh=0;38;2;166;227;161:*.so=1;38;2;243;139;168:*.td=0;38;2;166;227;161:*.ts=0;38;2;166;227;161:*.ui=0;38;2;249;226;175:*.vb=0;38;2;166;227;161:*.wv=0;38;2;242;205;205:*.xz=4;38;2;116;199;236:*.aif=0;38;2;242;205;205:*.ape=0;38;2;242;205;205:*.apk=4;38;2;116;199;236:*.arj=4;38;2;116;199;236:*.asa=0;38;2;166;227;161:*.aux=0;38;2;88;91;112:*.avi=0;38;2;242;205;205:*.awk=0;38;2;166;227;161:*.bag=4;38;2;116;199;236:*.bak=0;38;2;88;91;112:*.bat=1;38;2;243;139;168:*.bbl=0;38;2;88;91;112:*.bcf=0;38;2;88;91;112:*.bib=0;38;2;249;226;175:*.bin=4;38;2;116;199;236:*.blg=0;38;2;88;91;112:*.bmp=0;38;2;242;205;205:*.bsh=0;38;2;166;227;161:*.bst=0;38;2;249;226;175:*.bz2=4;38;2;116;199;236:*.c++=0;38;2;166;227;161:*.cfg=0;38;2;249;226;175:*.cgi=0;38;2;166;227;161:*.clj=0;38;2;166;227;161:*.com=1;38;2;243;139;168:*.cpp=0;38;2;166;227;161:*.css=0;38;2;166;227;161:*.csv=0;38;2;249;226;175:*.csx=0;38;2;166;227;161:*.cxx=0;38;2;166;227;161:*.deb=4;38;2;116;199;236:*.def=0;38;2;166;227;161:*.dll=1;38;2;243;139;168:*.dmg=4;38;2;116;199;236:*.doc=0;38;2;243;139;168:*.dot=0;38;2;166;227;161:*.dox=0;38;2;148;226;213:*.dpr=0;38;2;166;227;161:*.elc=0;38;2;166;227;161:*.elm=0;38;2;166;227;161:*.epp=0;38;2;166;227;161:*.eps=0;38;2;242;205;205:*.erl=0;38;2;166;227;161:*.exe=1;38;2;243;139;168:*.exs=0;38;2;166;227;161:*.fls=0;38;2;88;91;112:*.flv=0;38;2;242;205;205:*.fnt=0;38;2;242;205;205:*.fon=0;38;2;242;205;205:*.fsi=0;38;2;166;227;161:*.fsx=0;38;2;166;227;161:*.gif=0;38;2;242;205;205:*.git=0;38;2;88;91;112:*.gvy=0;38;2;166;227;161:*.h++=0;38;2;166;227;161:*.hpp=0;38;2;166;227;161:*.htc=0;38;2;166;227;161:*.htm=0;38;2;249;226;175:*.hxx=0;38;2;166;227;161:*.ico=0;38;2;242;205;205:*.ics=0;38;2;243;139;168:*.idx=0;38;2;88;91;112:*.ilg=0;38;2;88;91;112:*.img=4;38;2;116;199;236:*.inc=0;38;2;166;227;161:*.ind=0;38;2;88;91;112:*.ini=0;38;2;249;226;175:*.inl=0;38;2;166;227;161:*.ipp=0;38;2;166;227;161:*.iso=4;38;2;116;199;236:*.jar=4;38;2;116;199;236:*.jpg=0;38;2;242;205;205:*.kex=0;38;2;243;139;168:*.kts=0;38;2;166;227;161:*.log=0;38;2;88;91;112:*.ltx=0;38;2;166;227;161:*.lua=0;38;2;166;227;161:*.m3u=0;38;2;242;205;205:*.m4a=0;38;2;242;205;205:*.m4v=0;38;2;242;205;205:*.mid=0;38;2;242;205;205:*.mir=0;38;2;166;227;161:*.mkv=0;38;2;242;205;205:*.mli=0;38;2;166;227;161:*.mov=0;38;2;242;205;205:*.mp3=0;38;2;242;205;205:*.mp4=0;38;2;242;205;205:*.mpg=0;38;2;242;205;205:*.nix=0;38;2;249;226;175:*.odp=0;38;2;243;139;168:*.ods=0;38;2;243;139;168:*.odt=0;38;2;243;139;168:*.ogg=0;38;2;242;205;205:*.org=0;38;2;249;226;175:*.otf=0;38;2;242;205;205:*.out=0;38;2;88;91;112:*.pas=0;38;2;166;227;161:*.pbm=0;38;2;242;205;205:*.pdf=0;38;2;243;139;168:*.pgm=0;38;2;242;205;205:*.php=0;38;2;166;227;161:*.pid=0;38;2;88;91;112:*.pkg=4;38;2;116;199;236:*.png=0;38;2;242;205;205:*.pod=0;38;2;166;227;161:*.ppm=0;38;2;242;205;205:*.pps=0;38;2;243;139;168:*.ppt=0;38;2;243;139;168:*.pro=0;38;2;148;226;213:*.ps1=0;38;2;166;227;161:*.psd=0;38;2;242;205;205:*.pyc=0;38;2;88;91;112:*.pyd=0;38;2;88;91;112:*.pyo=0;38;2;88;91;112:*.rar=4;38;2;116;199;236:*.rpm=4;38;2;116;199;236:*.rst=0;38;2;249;226;175:*.rtf=0;38;2;243;139;168:*.sbt=0;38;2;166;227;161:*.sql=0;38;2;166;227;161:*.sty=0;38;2;88;91;112:*.svg=0;38;2;242;205;205:*.swf=0;38;2;242;205;205:*.swp=0;38;2;88;91;112:*.sxi=0;38;2;243;139;168:*.sxw=0;38;2;243;139;168:*.tar=4;38;2;116;199;236:*.tbz=4;38;2;116;199;236:*.tcl=0;38;2;166;227;161:*.tex=0;38;2;166;227;161:*.tgz=4;38;2;116;199;236:*.tif=0;38;2;242;205;205:*.tml=0;38;2;249;226;175:*.tmp=0;38;2;88;91;112:*.toc=0;38;2;88;91;112:*.tsx=0;38;2;166;227;161:*.ttf=0;38;2;242;205;205:*.txt=0;38;2;249;226;175:*.vcd=4;38;2;116;199;236:*.vim=0;38;2;166;227;161:*.vob=0;38;2;242;205;205:*.wav=0;38;2;242;205;205:*.wma=0;38;2;242;205;205:*.wmv=0;38;2;242;205;205:*.xcf=0;38;2;242;205;205:*.xlr=0;38;2;243;139;168:*.xls=0;38;2;243;139;168:*.xml=0;38;2;249;226;175:*.xmp=0;38;2;249;226;175:*.yml=0;38;2;249;226;175:*.zip=4;38;2;116;199;236:*.zsh=0;38;2;166;227;161:*.zst=4;38;2;116;199;236:*TODO=1:*hgrc=0;38;2;148;226;213:*.bash=0;38;2;166;227;161:*.conf=0;38;2;249;226;175:*.dart=0;38;2;166;227;161:*.diff=0;38;2;166;227;161:*.docx=0;38;2;243;139;168:*.epub=0;38;2;243;139;168:*.fish=0;38;2;166;227;161:*.flac=0;38;2;242;205;205:*.h264=0;38;2;242;205;205:*.hgrc=0;38;2;148;226;213:*.html=0;38;2;249;226;175:*.java=0;38;2;166;227;161:*.jpeg=0;38;2;242;205;205:*.json=0;38;2;249;226;175:*.less=0;38;2;166;227;161:*.lisp=0;38;2;166;227;161:*.lock=0;38;2;88;91;112:*.make=0;38;2;148;226;213:*.mpeg=0;38;2;242;205;205:*.opus=0;38;2;242;205;205:*.orig=0;38;2;88;91;112:*.pptx=0;38;2;243;139;168:*.psd1=0;38;2;166;227;161:*.psm1=0;38;2;166;227;161:*.purs=0;38;2;166;227;161:*.rlib=0;38;2;88;91;112:*.sass=0;38;2;166;227;161:*.scss=0;38;2;166;227;161:*.tbz2=4;38;2;116;199;236:*.tiff=0;38;2;242;205;205:*.toml=0;38;2;249;226;175:*.webm=0;38;2;242;205;205:*.webp=0;38;2;242;205;205:*.woff=0;38;2;242;205;205:*.xbps=4;38;2;116;199;236:*.xlsx=0;38;2;243;139;168:*.yaml=0;38;2;249;226;175:*.cabal=0;38;2;166;227;161:*.cache=0;38;2;88;91;112:*.class=0;38;2;88;91;112:*.cmake=0;38;2;148;226;213:*.dyn_o=0;38;2;88;91;112:*.ipynb=0;38;2;166;227;161:*.mdown=0;38;2;249;226;175:*.patch=0;38;2;166;227;161:*.scala=0;38;2;166;227;161:*.shtml=0;38;2;249;226;175:*.swift=0;38;2;166;227;161:*.toast=4;38;2;116;199;236:*.xhtml=0;38;2;249;226;175:*README=0;38;2;30;30;46;48;2;249;226;175:*passwd=0;38;2;249;226;175:*shadow=0;38;2;249;226;175:*.config=0;38;2;249;226;175:*.dyn_hi=0;38;2;88;91;112:*.flake8=0;38;2;148;226;213:*.gradle=0;38;2;166;227;161:*.groovy=0;38;2;166;227;161:*.ignore=0;38;2;148;226;213:*.matlab=0;38;2;166;227;161:*COPYING=0;38;2;147;153;178:*INSTALL=0;38;2;30;30;46;48;2;249;226;175:*LICENSE=0;38;2;147;153;178:*TODO.md=1:*.desktop=0;38;2;249;226;175:*.gemspec=0;38;2;148;226;213:*Doxyfile=0;38;2;148;226;213:*Makefile=0;38;2;148;226;213:*TODO.txt=1:*setup.py=0;38;2;148;226;213:*.DS_Store=0;38;2;88;91;112:*.cmake.in=0;38;2;148;226;213:*.fdignore=0;38;2;148;226;213:*.kdevelop=0;38;2;148;226;213:*.markdown=0;38;2;249;226;175:*.rgignore=0;38;2;148;226;213:*COPYRIGHT=0;38;2;147;153;178:*configure=0;38;2;148;226;213:*.gitconfig=0;38;2;148;226;213:*.gitignore=0;38;2;148;226;213:*.localized=0;38;2;88;91;112:*.scons_opt=0;38;2;88;91;112:*CODEOWNERS=0;38;2;148;226;213:*Dockerfile=0;38;2;249;226;175:*INSTALL.md=0;38;2;30;30;46;48;2;249;226;175:*README.txt=0;38;2;30;30;46;48;2;249;226;175:*SConscript=0;38;2;148;226;213:*SConstruct=0;38;2;148;226;213:*.gitmodules=0;38;2;148;226;213:*.synctex.gz=0;38;2;88;91;112:*.travis.yml=0;38;2;166;227;161:*INSTALL.txt=0;38;2;30;30;46;48;2;249;226;175:*LICENSE-MIT=0;38;2;147;153;178:*MANIFEST.in=0;38;2;148;226;213:*Makefile.am=0;38;2;148;226;213:*Makefile.in=0;38;2;88;91;112:*.applescript=0;38;2;166;227;161:*.fdb_latexmk=0;38;2;88;91;112:*CONTRIBUTORS=0;38;2;30;30;46;48;2;249;226;175:*appveyor.yml=0;38;2;166;227;161:*configure.ac=0;38;2;148;226;213:*.clang-format=0;38;2;148;226;213:*.gitattributes=0;38;2;148;226;213:*.gitlab-ci.yml=0;38;2;166;227;161:*CMakeCache.txt=0;38;2;88;91;112:*CMakeLists.txt=0;38;2;148;226;213:*LICENSE-APACHE=0;38;2;147;153;178:*CONTRIBUTORS.md=0;38;2;30;30;46;48;2;249;226;175:*.sconsign.dblite=0;38;2;88;91;112:*CONTRIBUTORS.txt=0;38;2;30;30;46;48;2;249;226;175:*requirements.txt=0;38;2;148;226;213:*package-lock.json=0;38;2;88;91;112:*.CFUserTextEncoding=0;38;2;88;91;112"

setopt MENU_COMPLETE
unsetopt LIST_AMBIGUOUS
setopt COMPLETE_IN_WORD
setopt AUTO_LIST

# autoload -Uz compinstall && compinstall

alias -g ...='../..'
alias -g ....='../../..'
alias -g .....='../../../..'
alias -g ......='../../../../..'

if [[ -f ~/local/bin/tmux ]]; then
  alias tmux='~/local/bin/tmux'
elif command -v tmux &>/dev/null; then
  alias tmux=tmux
else
  echo 'need tmux in ~/loca/bin/tmux'
fi

ta () {
  if [ ! -z $TMUX ] && [ ! -z $1 ]
  then
    tmux detach -E "tmux new -A -s '$1'"
  elif [ ! -z $TMUX ]
  then
    return
  else
    tmux new -As main
  fi
}

# lets go right to businees
command -v tmux &> /dev/null && ta || echo "tmux not found..."

typeset -U path

# zsh completion
[ ! -d ~/.zsh/zsh-autosuggestions ] && git clone https://github.com/zsh-users/zsh-autosuggestions ~/.zsh/zsh-autosuggestions
source ~/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh

# [ ! -d ~/.zsh/zsh-completions ] && git clone https://github.com/zsh-users/zsh-completions.git ~/.zsh/zsh-completions
#
# fpath=$(~/.zsh/zsh-completions $fpath)

# autoload -Uz compinit && compinit -C
autoload -Uz compinit && compinit

zstyle ':completion:*:default' list-colors ""
zstyle ':completion:*:default' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion::complete:*' gain-privileges 1

# % cd /u/lo/b⇥ 
# % cd /usr/local/bin 
zstyle ':completion:*' matcher-list 'm:{[:lower:][:upper:]}={[:upper:][:lower:]}' 'm:{[:lower:][:upper:]}={[:upper:][:lower:]} l:|=* r:|=*' 'm:{[:lower:][:upper:]}={[:upper:][:lower:]} l:|=* r:|=*' 'm:{[:lower:][:upper:]}={[:upper:][:lower:]} l:|=* r:|=*'
zstyle ':completion:*' list-suffixes
zstyle ':completion:*' expand prefix suffix

# partial completion suggestions

ZSH_AUTOSUGGEST_STRATEGY=(history completion)
ZSH_AUTOSUGGEST_USE_ASYNC=true

# fix certain weird characters
setopt COMBINING_CHARS

# no beep, ever
setopt NO_BEEP

[[ -d ~/.tmp ]] || mkdir -p ~/.tmp

# create ram drive
# [[ -d /Volumes/ohmy ]] || diskutil erasevolume HFS+ "ohmy" `hdiutil attach -nomount ram://20480`

ZSH_DISABLE_COMPFIX="true"

export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES

# If you come from bash you might have to change your $PATH.

# Uncomment the following line to disable auto-setting terminal title.
DISABLE_AUTO_TITLE="true"
# much, much faster.
DISABLE_UNTRACKED_FILES_DIRTY="true"

if [[ $OSTYPE == "linux-gnu"* ]]; then
  export DISPLAY=:0.0
fi

if [[ -f ~/nvim/bin/nvim ]]; then
  alias vim='~/nvim/bin/nvim'
  alias nvim='~/nvim/bin/nvim'
  # legacy vim
  alias vi=vim
  alias vil='/usr/bin/vim'
  alias vimdiff='~/nvim/bin/nvim -d'
elif command -v nvim &>/dev/null; then
  alias vim=$(whence nvim)
  alias nvim=vim
  alias vi=vim
  alias vil=vim
  alias vil='/usr/bin/vim'
  alias vimdiff='nvim -d'
  alias vl="vim -c \"normal '0\" -c \"bn\" -c \"bd\""
fi
export EDITOR=vim

if command -v kubectl &>/dev/null; then
  alias k='kubectl '
  # source <(kubectl completion zsh)
fi

alias vl="vim -c \"normal '0\" -c \"bn\" -c \"bd\""

# debug in headless mode, allows debugging session to start paused
alias dlvh="dlv debug --headless --api-version=2 --listen=127.0.0.1:2345"

# set nvim as man pager
if [[ "$(command -v nvim)" ]]; then
    export EDITOR=vim
    export MANPAGER='nvim +Man!'
    export MANWIDTH=999
fi

# functions

take () {
  [ -z $1 ] && return
  local dir="$@"
  mkdir -p "${dir// /-}"; cd "${dir// /-}"
}

mkt () {
  git tag -a $1 -m "added tag $1"; git push origin $1
}

rmt () {
  git tag -d $1;git push --delete origin $1
}

vq () {
  # pass all args to rg via $@ .. allows to append rg flags, muhahah
  vim -q <(rg --vimgrep --pcre2 -i -S $@) +"copen 6"
}

timezsh() {
  shell=${1-$SHELL}
  for i in $(seq 1 10); do /usr/bin/time $shell -i -c exit; done
}

alias gd='git diff'
alias gs='git status'
alias cdr='cd "$(git rev-parse --show-toplevel 2>/dev/null)"  &>/dev/null'
alias c='clear'

if [[ -f '/opt/homebrew/opt/fzf/bin/fzf' ]]; then
 alias fzf='/opt/homebrew/opt/fzf/bin/fzf'
elif [ -f '~/.fzf/bin/fzf' ]; then
  alias fzf='~/.fzf/bin/fzf'
fi

alias tf='terraform'
alias rdp='xfreerdp +clipboard'
alias ssh='TERM=xterm-256color ssh '

# GpG
# alias gpg-agent='gpg-agent --keep-display'
# export GPG_TTY="$(tty)"

# init new repo
ginit () {
  git init
  cp ~/.dotfiles/gitignore .gitignore
  git add .
  git commit -am 'initial commit'
}

gitl () {
    my_dir=$PWD
    cdr
    git add .
    f=$(git status --porcelain | cut -c4- | head -n 4)
    more_changes=$(git status --porcelain | sed -n 5p)
    [ -n "$more_changes" ] && f="$f ..."
    if test -z "$1"; then
      # replace new line, using longest match //
      # $'\n' represents a newline character in bash. The $ sign here is telling the
      # shell to interpret the following characters ('\n') as a special escape
      # sequence, translating it into an actual newline character.
      #
      # So, in the expression ${f//$'\n'/ }, the first $ is used to get the value of
      # the f variable, and the second $ is used to specify a newline character that
      # you want to replace with a space within the value of f.
      git commit "-m updates -> ${f//$'\n'/ }"
    else
      git commit '-m' "$1 -> ${f//$'\n'/ }"
    fi
    if [ ! -z "$(git remote -v)" ]; then
      git push
    fi
    cd $my_dir
}

dotp () {
    my_dir=$PWD
    cd ~/.dotfiles
    git pull
    cd $my_dir
}

dotc () {
    my_dir=$PWD
    cd ~/.dotfiles
    git pull
    git add .
    f=$(git status --porcelain | cut -c4- | head -n 4)
    more_changes=$(git status --porcelain | sed -n 5p)
    [ -n "$more_changes" ] && f="$f ..."
    git commit "-m updates -> ${f//$'\n'/ }"
    git push
    cd $my_dir
}

# function ta() { tmux detach -E "tmux new -A -s '$1'"; }

# activate virtual environment if there is one in this repo
va () {
  if [[ -d $(git rev-parse --show-toplevel 2>/dev/null)/venv ]]; then
    source $(git rev-parse --show-toplevel)/venv/bin/activate
  else 
    source $HOME/.virtualenvs/prod3/bin/activate
  fi
  echo $(which python3)
}

# deactivate virtual environment if there is one in this repo
vd () {
  deactivate 2>/dev/null
  source $HOME/.virtualenvs/prod3/bin/activate
}

dev_env () {
  python3 -m venv ~/.virtualenvs/prod3
  source ~/.virtualenvs/bin/active
  pip install -U pip
  pip install debugpy black mdformat rpdb ipython ipdb dns yamllint ansible ansible-lint
}

vc () {
  deactivate 2>/dev/null
  venv_dir="venv"
  my_dir=$PWD
  if [[ -d $(git rev-parse --show-toplevel 2>/dev/null) ]]; then
    cd $(git rev-parse --show-toplevel)
  fi
  if [ ! -z "$1" ]; then
    venv_dir=$1
  fi
  python3 --version
  python3 -m venv $venv_dir
  source $venv_dir/bin/activate
  pip install pip wheel pyright ansible black pytest yamllint ansible-lint -U
  pip freeze > requirements.txt
  echo ""
  echo ""
  echo ""
  echo "*************** :) *******************"
  which python
  cd $my_dir
}

dp() {
  unset http_proxy
  unset https_proxy
  unset all_proxy
  unset no_proxy
  echo "cli proxy destroy done..."
}

# default virtual env if exists
# if [[ -f ~/.virtualenvs/prod3/bin/activate ]]; then
#   source ~/.virtualenvs/prod3/bin/activate
# fi

# disable virtualenv prompt
export VIRTUAL_ENV_DISABLE_PROMPT=1
export XCURSOR_SIZE=60

export FZF_DEFAULT_OPTS='--height 40% --no-preview'

# export FZF_DEFAULT_OPTS=$FZF_DEFAULT_OPTS'
#     --color=fg:#e5e9f0,hl:#81a1c1
#     --color=fg+:#e5e9f0,bg+:#3b4252,hl+:#81a1c1
#     --color=info:#eacb8a,prompt:#bf6069,pointer:#b48dac
#     --color=marker:#a3be8b,spinner:#b48dac,header:#a3be8b'

export FZF_DEFAULT_OPTS=" \
--color=bg+:#313244,bg:#1e1e2e,spinner:#f5e0dc,hl:#f38ba8 \
--color=fg:#cdd6f4,header:#f38ba8,info:#cba6f7,pointer:#f5e0dc \
--color=marker:#f5e0dc,fg+:#cdd6f4,prompt:#cba6f7,hl+:#f38ba8"

FD_CMD='fd -I --type f --exclude ".git" --exclude "__pycache__" --follow --hidden'
if command -v fd &>/dev/null; then
  _fzf_compgen_path() {
    fd -I --hidden --follow --exclude ".git" . "$1"
  }

  # Use fd to generate the list for directory completion
  _fzf_compgen_dir() {
    fd -I --type d --hidden --follow --exclude ".git" . "$1"
  }
  export FZF_ALT_C_COMMAND=$FD_CMD
  export FZF_DEFAULT_COMMAND=$FD_CMD
  export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
  export FZF_COMPLETION_TRIGGER="~~"
else
  echo 'download fd from: https://github.com/sharkdp/fd/releases'
  brew install fd
fi

if [[ $OSTYPE == "darwin"* ]]; then
  [ ! -d /opt/homebrew/opt/gnu-sed/libexec/gnubin &>/dev/null ] && brew install gnu-sed
fi

# pretty colors

export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE='fg=60'

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# defaults write com.googlecode.iterm2 AppleFontSmoothing -integer 1

zvm_after_init_commands+=('[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh')

eval "$(starship init zsh)"

# defaults to vi-mode, and let us toggle back and forth

bindkey -v
v () {
  bindkey -v; clear
}

# e () {
#   bindkey -e; clear
# }

# alias v='bindkey -v'
# alias e='bindkey -e'

bindkey "^E" end-of-line
bindkey "^A" beginning-of-line
bindkey "^N" down-line-or-history
bindkey "^O" accept-line-and-down-history
bindkey "^P" up-line-or-history
bindkey "^R" fzf-history-widget
bindkey "^T" fzf-file-widget

# Adding a trailing space to the command being aliased causes other aliased commands to expand:
alias xargs='xargs '

get_root_dir(){
  echo `git rev-parse --show-toplevel 2>/dev/null` || echo '.'
}

_d () {
  cdr
  cd "$(fd --type d -HI --exclude ".git" --exclude "__pycache__" . | fzf --height 30% --reverse --border)"
}

# _d declear as widget for zsh
zle -N _d
bindkey -s "^G" _d^M

vs () {
  vim "$(fd --type f -HI --exclude ".git" --exclude "__pycache__" . | fzf --height 30% --reverse --border)" || return
}

_vs () {
  vim "$(fd --type f -HI --exclude ".git" --exclude "__pycache__" . | fzf --height 30% --reverse --border)" || return
}

# _vs declear as widget for zsh
zle -N _vs
bindkey -s "^S" _vs^M

# ci" in vi-mode
autoload -U select-quoted
zle -N select-quoted
for m in visual viopp; do
  for c in {a,i}{\',\",\`}; do
    bindkey -M $m $c select-quoted
  done
done

# ci{, ci(, di{ etc.. in vi-mode
autoload -U select-bracketed
zle -N select-bracketed
for m in visual viopp; do
  for c in {a,i}${(s..)^:-'()[]{}<>bB'}; do
    bindkey -M $m $c select-bracketed
  done
done

# sh -c "$(curl -fsSL https://starship.rs/install.sh)"

# if [[ $TERM != "tmux-256color" ]]; then
# 	echo 'not in tmux'
# fi

# max font smoothing = 3
# defaults -currentHost write -g AppleFontSmoothing -int 0
if [[ $OSTYPE == "darwin"* ]]; then
  defaults write -g AppleFontSmoothing -int 0
  defaults write -g ApplePressAndHoldEnabled -bool false
 if command -v gls &>/dev/null; then
   alias ls='gls --color'
 else
   echo "brew instal coreutils - we need gnu-ls"
   brew install coreutils
   alias ls='gls --color'
 fi
fi

export HISTFILE=~/.zsh_history
# HISTSIZE should be > SAVEHIST or dups will show up
export HISTSIZE=10000   # the number of items for the internal history list
export SAVEHIST=9000   # maximum number of items for the history file
# export HISTTIMEFORMAT='[%F %T] '
export HISTIGNORE='ls:ll:pwd'
HISTDUP=erase

# The meaning of these options can be found in man page of `zshoptions`.
setopt HIST_IGNORE_DUPS
setopt HIST_FIND_NO_DUPS
setopt HIST_EXPIRE_DUPS_FIRST # remove dups first
setopt INC_APPEND_HISTORY # record command immediatly instead of waiting until exit
setopt SHARE_HISTORY
setopt HIST_IGNORE_ALL_DUPS  # do not put duplicated command into history list
setopt HIST_SAVE_NO_DUPS  # do not save duplicated command
setopt HIST_REDUCE_BLANKS  # remove unnecessary blanks

if [[ $OSTYPE == "linux"* ]];  then
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
  [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
  alias ls='ls --color'
fi

if [[ $OSTYPE == "darwin"* ]];  then
  KRATE=1
  INITKRATE=9
  # show current settings:
  # defaults read NSGlobalDomain InitialKeyRepeat
  # normal is 2, lower is faster
  defaults write -g KeyRepeat -int $KRATE
  # normal minimum is 15 (225 ms) , higher is faster
  defaults write -g InitialKeyRepeat -int $INITKRATE
fi

# unset display in wsl or vim will starup slow
[[ $(uname -a) == *"Microsoft"* ]] && unset DISPLAY

# load other functions
if [ -f ~/.zshf ]; then
  source ~/.zshf
fi

# freeze tty
ttyctl -f

# prevent terminal from getting garbled up
autoload -Uz add-zsh-hook

function reset_broken_terminal () {
	printf '%b' '\e[0m\e(B\e)0\017\e[?5l\e7\e[0;0r\e8'
}

add-zsh-hook -Uz precmd reset_broken_terminal

# remember directories
# directory maps
alias -- -='cd -'
alias 0='cd -0'
alias 1='cd -1'
alias 2='cd -2'
alias 3='cd -3'
alias 4='cd -4'
alias 5='cd -5'
alias 6='cd -6'
alias 7='cd -7'
alias 8='cd -8'
alias 9='cd -9'

function d () {
  if [[ -n $1 ]]; then
    dirs "$@"
  else
    dirs -v | head -n 10
  fi
}

autoload -Uz add-zsh-hook

[ ! -d $HOME/.cache/zsh/ ] && mkdir -p $HOME/.cache/zsh/

DIRSTACKFILE="${XDG_CACHE_HOME:-$HOME/.cache}/zsh/dirs"
if [[ -f "$DIRSTACKFILE" ]] && (( ${#dirstack} == 0 )); then
	dirstack=("${(@f)"$(< "$DIRSTACKFILE")"}")
	[[ -d "${dirstack[1]}" ]] && cd -- "${dirstack[1]}"
fi
chpwd_dirstack() {
	print -l -- "$PWD" "${(u)dirstack[@]}" > "$DIRSTACKFILE"
}
add-zsh-hook -Uz chpwd chpwd_dirstack

DIRSTACKSIZE='10'

setopt AUTO_PUSHD PUSHD_SILENT PUSHD_TO_HOME

## Remove duplicate entries
setopt PUSHD_IGNORE_DUPS

## This reverts the +/- operators.
setopt PUSHD_MINUS

# git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm

[ ! -d ~/.tmux/plugins/tpm ] && git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
# load this last

[ -n $VIRTUAL_ENV ] && . ~/.virtualenvs/prod3/bin/activate

# [ ! -d ~/.zsh/zsh-syntax-highlighting &>/dev/null ] &&  git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ~/.zsh/zsh-syntax-highlighting
# source ~/.zsh/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
